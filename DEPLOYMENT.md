# TribeChat - Deployment Guide

This guide covers both development and production deployment of TribeChat, including network access configuration.

## Table of Contents

- [Quick Start (Development)](#quick-start-development)
- [Network Access Setup](#network-access-setup)
- [Production Deployment](#production-deployment)
- [Configuration](#configuration)
- [Troubleshooting](#troubleshooting)

---

## Quick Start (Development)

### Prerequisites

- Docker and Docker Compose installed
- Git installed
- Ports 3333, 5432, and 9000 available

### Steps

1. **Clone the repository**
   ```bash
   git clone https://github.com/damianecek/TribeChat.git
   cd TribeChat
   ```

2. **Configure environment**
   ```bash
   cp backend/.env.example backend/.env
   ```

3. **Generate APP_KEY**
   ```bash
   docker compose run --rm backend node ace generate:key
   ```
   Copy the generated key to `backend/.env` in the `APP_KEY` field.

4. **Start the application**
   ```bash
   ./start-dev.sh
   ```
   Or manually:
   ```bash
   docker compose up --build
   ```

5. **Access the application**
   - Frontend: http://localhost:9000
   - Backend API: http://localhost:3333
   - Health Check: http://localhost:3333/health

---

## Network Access Setup

To allow other devices on your local network to access TribeChat:

### 1. Find Your Local IP Address

**Linux/Mac:**
```bash
hostname -I
# or
ifconfig | grep "inet "
```

**Windows:**
```cmd
ipconfig
```

Look for your local IP (usually starts with 192.168.x.x or 10.0.x.x)

### 2. Configure Frontend Environment

Create or edit `frontend/.env`:
```env
VITE_API_URL=http://YOUR_LOCAL_IP:3333
VITE_WS_URL=http://YOUR_LOCAL_IP:3333
NODE_ENV=development
```

Example:
```env
VITE_API_URL=http://192.168.1.100:3333
VITE_WS_URL=http://192.168.1.100:3333
NODE_ENV=development
```

### 3. Configure Backend CORS

Update `backend/.env` to allow your network:
```env
ALLOWED_ORIGINS=http://localhost:9000,http://127.0.0.1:9000,http://192.168.*.*:9000
```

### 4. Configure Firewall

**Linux (Ubuntu/Debian):**
```bash
sudo ufw allow 3333
sudo ufw allow 9000
```

**Windows:**
- Open Windows Firewall
- Add inbound rules for ports 3333 and 9000

**Mac:**
- Go to System Preferences → Security & Privacy → Firewall
- Add rules for ports 3333 and 9000

### 5. Restart the Application

```bash
docker compose down
docker compose up --build
```

### 6. Access from Other Devices

On other devices connected to the same network:
- Open browser and navigate to: `http://YOUR_LOCAL_IP:9000`
- Example: `http://192.168.1.100:9000`

---

## Production Deployment

### Prerequisites

- Docker and Docker Compose installed
- Domain name (optional, but recommended)
- SSL certificate (recommended for production)

### Steps

1. **Create production environment file**
   ```bash
   cp backend/.env.production.example backend/.env
   ```

2. **Configure production settings**
   Edit `backend/.env`:
   ```env
   NODE_ENV=production
   APP_KEY=your-generated-key
   DB_USER=your_secure_user
   DB_PASSWORD=your_secure_password
   ALLOWED_ORIGINS=https://your-domain.com,http://your-server-ip
   ```

3. **Configure frontend production settings**
   Edit `frontend/.env.production`:
   ```env
   VITE_API_URL=https://your-domain.com/api
   VITE_WS_URL=wss://your-domain.com
   NODE_ENV=production
   ```

4. **Generate APP_KEY**
   ```bash
   docker compose run --rm backend node ace generate:key
   ```

5. **Start production environment**
   ```bash
   ./start-prod.sh
   ```
   Or manually:
   ```bash
   docker compose -f docker-compose.production.yml up --build -d
   ```

6. **Verify deployment**
   - Frontend: http://your-server-ip:80
   - Backend Health: http://your-server-ip:3333/health

### Production Checklist

- [ ] APP_KEY is generated and set
- [ ] Database credentials are strong and secure
- [ ] ALLOWED_ORIGINS includes your domain/IP
- [ ] Frontend .env.production has correct API URLs
- [ ] Firewall rules are configured
- [ ] SSL certificate is installed (recommended)
- [ ] Database backups are configured
- [ ] Monitoring is set up

---

## Configuration

### Backend Environment Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `NODE_ENV` | Application environment | `development` or `production` |
| `PORT` | Backend port | `3333` |
| `HOST` | Bind address | `0.0.0.0` |
| `APP_KEY` | Encryption key | Generated by `node ace generate:key` |
| `DB_HOST` | Database host | `db` (Docker) or `localhost` |
| `DB_PORT` | Database port | `5432` |
| `DB_USER` | Database user | `root` |
| `DB_PASSWORD` | Database password | `root` |
| `DB_DATABASE` | Database name | `app` |
| `ALLOWED_ORIGINS` | Allowed CORS origins | `http://localhost:9000,http://192.168.*.*:9000` |

### Frontend Environment Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `VITE_API_URL` | Backend API URL | `http://localhost:3333` |
| `VITE_WS_URL` | WebSocket URL | `http://localhost:3333` |
| `NODE_ENV` | Build environment | `development` or `production` |

### Docker Compose Variables

For production deployment, you can override defaults:

```bash
export VITE_API_URL=http://192.168.1.100:3333
export VITE_WS_URL=http://192.168.1.100:3333
export FRONTEND_PORT=8080
docker compose -f docker-compose.production.yml up --build
```

---

## Troubleshooting

### Cannot connect from other devices

1. **Check firewall**: Ensure ports 3333 and 9000 are open
2. **Verify CORS**: Check `ALLOWED_ORIGINS` in `backend/.env`
3. **Check API URL**: Frontend must use the host machine's IP, not localhost
4. **Network issues**: Ensure devices are on the same network

### CORS errors in browser console

Update `backend/.env`:
```env
ALLOWED_ORIGINS=http://localhost:9000,http://192.168.*.*:9000
```

### WebSocket connection fails

1. Ensure `VITE_WS_URL` matches `VITE_API_URL`
2. Check backend logs: `docker compose logs backend`
3. Verify WebSocket endpoint: `http://YOUR_IP:3333/socket.io/`

### Database connection errors

1. Check if database is running: `docker compose ps`
2. Verify credentials in `backend/.env`
3. Check database logs: `docker compose logs db`

### Frontend shows blank page

1. Check browser console for errors
2. Verify API URL is accessible: `curl http://YOUR_API_URL/health`
3. Check frontend logs: `docker compose logs frontend`

### Build fails

1. Clear Docker cache: `docker compose down -v`
2. Remove images: `docker system prune -a`
3. Rebuild: `docker compose build --no-cache`

### Health check fails

Check backend is responding:
```bash
curl http://localhost:3333/health
```

Should return:
```json
{
  "status": "ok",
  "timestamp": "2024-01-01T00:00:00.000Z",
  "service": "TribeChat API"
}
```

---

## Advanced Configuration

### Using a Reverse Proxy (Recommended for Production)

For production deployments, it's recommended to use a reverse proxy like nginx or Traefik to:
- Handle SSL/TLS termination
- Serve both frontend and backend on the same domain
- Improve security with rate limiting

Example nginx configuration:

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # Frontend
    location / {
        proxy_pass http://localhost:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Backend API
    location /api {
        proxy_pass http://localhost:3333;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # WebSocket
    location /socket.io {
        proxy_pass http://localhost:3333;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

### Environment-Specific Configurations

You can create multiple environment files:
- `.env.development` - Local development
- `.env.staging` - Staging environment
- `.env.production` - Production environment

Load the appropriate file based on your deployment needs.

---

## Support

For issues and questions:
- GitHub Issues: https://github.com/damianecek/TribeChat/issues
- Check logs: `docker compose logs`

---

## Security Notes

1. **Never commit `.env` files** to version control
2. **Use strong passwords** for production databases
3. **Enable HTTPS** for production deployments
4. **Keep dependencies updated**: `npm audit` and `docker pull`
5. **Regular backups** of the database
6. **Monitor logs** for suspicious activity
